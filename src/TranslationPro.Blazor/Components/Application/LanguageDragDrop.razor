@using EventAggregator.Blazor
@using TranslationPro.Blazor.Events

@if (items.Count > 0)
{
    
    <DropContainer @ref="dropContainer" TItem="DropItem" Items="@items" ItemsFilter="@((item, dropZone) => item.Group == dropZone)" ItemDropped="@ItemDropped" Flex="Flex.Wrap.Grow.Is1">
        <ChildContent>
            <DropZone TItem="DropItem" Name="Disabled" Border="Border.Rounded" Background="Background.Light" Padding="Padding.Is3" Margin="Margin.Is3" Flex="Flex.Grow.Is1">
                <Heading Size="HeadingSize.Is4" Margin="Margin.Is3.FromBottom">Available</Heading>
            </DropZone>
            <DropZone TItem="DropItem" Name="Enabled" Border="Border.Rounded" Background="Background.Light" Padding="Padding.Is3" Margin="Margin.Is3" Flex="Flex.Grow.Is1">
                <Heading Size="HeadingSize.Is4" Margin="Margin.Is3.FromBottom">Enabled</Heading>
            </DropZone>
        </ChildContent>
        <ItemTemplate>
            <Card Shadow="Shadow.Default" Margin="Margin.Is3.OnY">
                <CardBody>
                    @context.Name
                </CardBody>
            </Card>
        </ItemTemplate>
    </DropContainer>
}
@code {

    DropContainer<DropItem> dropContainer;

    [CascadingParameter]
    public IEventAggregator EventAggregator { get; set; }

    [CascadingParameter]
    public ApplicationOutput Application { get; set; }

    [Inject]
    private ILanguagesController LanguageService { get; set; }

    [Inject]
    protected IApplicationLanguagesController ApplicationLanguageService { get; set; }

    public class DropItem
    {
        public string Name { get; init; }

        public string LanguageId { get; set; }

        public string Group { get; set; }
    }

    public async Task Refresh()
    {
        await LoadData();
        dropContainer.Refresh();
    }
    

    private List<LanguageOutput> Languages { get; set; }

    private List<DropItem> items = new()
    {
    };

    
    public async Task HandleLanguageChange(IReadOnlyList<string> languages)
    {
        await ApplicationLanguageService.SyncLanguages(Application.Id, languages.ToArray());
    }

    
    public List<string> SelectedLanguages
    {
        get;
        set;
    }


    public async Task LoadData()
    {
        SelectedLanguages = Application.Languages.Select(x => x.Id).ToList();
        items.Clear();
        
        Languages = await LanguageService.GetLanguagesAsync();

        var languageIds = Languages.Select(x => x.Id).ToArray();

        foreach (var languageId in languageIds)
        {
            var dropItem = new DropItem()
            {
                Name = Languages.First(x => x.Id == languageId).Name,
                LanguageId = languageId
            };

            if (SelectedLanguages.Contains(languageId))
            {
                dropItem.Group = "Enabled";
            }
            else
            {
                dropItem.Group = "Disabled";
            }
            items.Add(dropItem);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task ItemDropped(DraggableDroppedEventArgs<DropItem> dropItem)
    {
        if (dropItem.DropZoneName == "Enabled")
        {
            await LanguageEnabled(dropItem.Item.LanguageId);
        }
        if (dropItem.DropZoneName == "Disabled")
        {
            await LanguageDisabled(dropItem.Item.LanguageId);
        }
        dropItem.Item.Group = dropItem.DropZoneName;

        await EventAggregator.PublishAsync(new LanguagesChangedEvent());
    }

    
    private async Task LanguageEnabled(string languageId)
    {
        await ApplicationLanguageService.AddLanguageToApplicationAsync(Application.Id,
            new ApplicationLanguageOptions()
            {
                LanguageId = languageId
            });
    }

    private async Task LanguageDisabled(string languageId)
    {
        await ApplicationLanguageService.RemoveLanguageFromApplicationAsync(Application.Id, languageId);
       
    }
}
