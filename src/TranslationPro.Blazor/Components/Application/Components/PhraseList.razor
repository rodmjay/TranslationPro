@using TranslationPro.Shared.Interfaces
@using TranslationPro.Shared.Models
@using TranslationPro.Shared.Common
@using TranslationPro.Shared.Filters

@if (PagedList != null)
{
    
    <DataGrid @ref="DataGrid" TItem="ApplicationPhraseOutput"
              Data="@PagedList.Items"
              ReadData="OnReadData"
              TotalItems="@PagedList.TotalItems"
              PageSize="@PagedList.PageSize"
              RowClicked="ItemSelected"
              CurrentPage="@PagedList.CurrentPage"
              PageChanged="PageChanged"

              ShowPager
              Responsive>
    
        <DataGridColumns>
            <DataGridColumn Field="@nameof(ApplicationPhraseOutput.Text)" Caption="Phrase"  ></DataGridColumn>
         <DataGridColumn Field="@nameof(ApplicationPhraseOutput.TranslationCount)" Caption="Translations"></DataGridColumn>
         <DataGridColumn Field="@nameof(ApplicationPhraseOutput.PendingTranslationCount)" Caption="Pending Translations"></DataGridColumn>
        </DataGridColumns>


    </DataGrid>
}


@code {

    private DataGrid<ApplicationPhraseOutput> DataGrid;

    private PagingQuery PagingQuery { get; set; } = new();

    [Parameter]
    public Guid ApplicationId { get; set; }

    [Inject]
    public IApplicationPhrasesController PhraseData { get; set; }

    [Inject]
    public NavigationManager NavigationManager { get; set; }

    private PagedList<ApplicationPhraseOutput> PagedList { get; set; }

    public async Task LoadData()
    {
        PagedList = await PhraseData.GetPhrasesAsync(ApplicationId, PagingQuery, new PhraseFilters());
    }

    public async Task Reload()
    {
        await LoadData();
        await DataGrid.Reload();
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task OnReadData(DataGridReadDataEventArgs<ApplicationPhraseOutput> e)
    {
        if (!e.CancellationToken.IsCancellationRequested)
        {
         
        }
    }

    private void ItemSelected(DataGridRowMouseEventArgs<ApplicationPhraseOutput> evnt)
    {
        NavigationManager.NavigateTo($"/applications/{ApplicationId}/phrases/{evnt.Item.Id}");
    }

    private async Task PageChanged(DataGridPageChangedEventArgs args)
    {
        var reload = false;

        if (PagedList.CurrentPage != args.Page)
        {
            reload = true;
            PagingQuery.Page = args.Page;
        }

        if (PagedList.PageSize != args.PageSize)
        {
            reload = true;
            PagingQuery.Size = args.PageSize;
        }

        if (reload)
        {
            await LoadData();
        }

    }

}
